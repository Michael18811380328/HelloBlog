## 第五章 运输层

### P57 5.1 运输层概述

物理层，数据链路层，网络层解决了异构网络中不同主机的通信，实际上计算机通信的实体是主机中独立的进程。

运输层解决的就是不同主机上的进程之间的通信（端到端协议）。网络层已经解决了底层的通信问题，给上层的运输层的逻辑通信提供服务。

运输层为应用层提供了两个协议：面向连接的 TCP 和 无连接的 UDP 协议。

### P58 5.2 运输层端口号、复用与分用

#### 运输层端口号

进程端口号：一个计算机上的进程使用进程端口号（PID）标识。不同操作系统中的进程需要通信，所以需要定制统一的规范。
运输层使用端口号区分不同的应用进程。端口号只在本机起到进程的识别，在不同计算机中，相同端口号之间没有联系。

端口号使用16比特表示，取值是0-65535。分成三类：

- 熟知端口号（世界范围内通用的端口号，HTTP 80端口，DNS 53端口）；
- 登记端口号（微软到官方机构，登记一下，使用 3389 作为微软远程桌面使用的端口号，MySQL 数据库登记某个端口等等）
- 短暂端口号（客户端和服务器通信时，会约定一个临时的动态端口，通信结束后，可以释放这个端口号，供其他客户进程使用）

#### 端口复用和分用

发送方的端口号复用，接收方的端口号分用。发送方：多个进程通过某个相同的运输层端口通信（不同时或者同时），就是发送方的端口号复用。接收方：某个运输层端口获取到报文后，然后分发给不同的进程，就是接收方的报文分用（不同时或者同时）。

UDP 用户数据报使用 17 协议字段；TCP 报文段使用 6 协议字段。

#### 实例（网络请求）

1、浏览器向 DNS 服务器发送请求（baidu.com的IP是什么），UDP 源端口 49152，目的端口 53。运输层将 UDP 用户数据包封装到 IP 数据报。

2、DNS 服务器接收到报文后，响应报文源端口 53，目的端口 49152，发送 DNS 解析后的结果。

3、浏览器接收到报文，获取 IP 地址，然后使用 HTTP 请求，将TCP报文段封装到 IP 数据报中，源端口 49152，目的端口 80 ，报文内容是 baidu.com/index.html

4、百度服务器接收后，响应报文源端口 80，目的端口 49152，返回响应报文。

5、浏览器收到报文，完成请求操作。

期间客户端的 49152 端口实现了端口复用。

### P59 5.3 UDP和TCP的对比-重点

UDP，User datagram Protocal 用户数据报协议

TCP，Transmission Control Protocal 传输控制协议

主要区别：

- 连接：UDP 直接无连接，TCP 面向连接，需要三次握手四次挥手。

- 通信数量：UDP 支持单播多播广播，TCP 仅支持单播。
- 传输单位：UDP 面向应用层报文（传输过程中，保留报文的边界）。TCP 是面向字节流（实现可靠传输）
- 可靠性：如果传输有误码，UDP 向上提供无连接不可靠的传输服务，接收方获取误码的报文，仅仅丢弃，其他什么都不做（不可靠），主要适用于IP电话或者视频会议等实时应用（偶尔丢包造成视频掉帧，不会有特别大的影响）最大努力交付，不使用流量控制和拥塞控制。TCP 是可靠信道，不会出现传输差错（误码，丢失，乱序，重复等），适用于可靠传输的应用，例如文件传输（出错了，文件就不能用了），使用流量控制和拥塞控制。
- 首部长度：UDP仅8字节，开销小（源端口，目的端口，长度，校验），TCP 报文首部字段最小20字节，最大60字节（增加了确认好，窗口，选项等参数）

### P60 5.4 TCP的流量控制

通常我们希望数据传输的更快一些，如果发送方，把数据发送的过快，接收方可能来不及接收，就会造成数据的丢失。

流量控制（flow control）就是让发送方的发送速率不要太快，要让接收方来得及接收。利用滑动窗口算法，可以在 TCP 连接上实现发送方的流量控制。

例子：AB两个主机建立 TCP 连接，A是发送端，B是接收端，B对A实现流量控制，下面是流量控制过程：

- A主机默认的发送窗口区间是400
- A主机发送了300字节数据
- B主机接收到前200字节数据，将200字节确认，最后100字节数据丢失了
- B主机流量控制：将接收窗口区间改成300，对主机A进行流量控制（ACK=1，ack=201, rwnd=300）ACK=1 表示确认报文段，ack 表示从201开始接收，rwnd 是接收方的窗口区间是300
- A主机调整发送窗口区间到300（可以发送201-500的数据），那么先发送300-400，400-500的数据，然后超时重传旧的200-300的数据（不能发送新的数据了）
- B主机接收到200-500的数据后，累计确认，将接收窗口改成100（ACK=1， ack = 501， rwnd = 100）
- A主机接收到ACK报文，将发送窗口区间改成100，向右滑动窗口，发送500-600数据
- B主机收到600后，把接收窗口改成0（假设B主机的栈内存临时用完了，不能接收新的数据报文了）
- A主机把发送窗口改成0，不能再发送数据了。

特殊情况

- 如果B主机内存有了，将接收窗口改成300，发送给主机A，但是丢包了。此时A主机等待B主机的非零窗口通知，B主机等待A主机发送数据，就形成了死锁
- TCP为每一个连接设置一个持续计时器。当持续计时器超时，A主机发送零窗口探测报文（如果B主机还没有内存，就告诉A主机窗口是0）如果没有回复，就断开 TCP 连接。

P61
5.5 TCP的拥塞控制
21:39
P62
5.6 TCP超时重传时间的选择
12:00
P63
5.7 TCP可靠传输的实现
18:04
P64
5.8.1 TCP的运输连接管理—TCP的连接建立
12:55
P65
5.8.2 TCP的运输连接管理—TCP的连接释放
09:53
P66
5.9 TCP报文段的首部格式
15:39
