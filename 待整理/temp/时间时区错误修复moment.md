# 时间时区错误修复moment

最近项目中，用户反馈一个时间不正确，老板让我立即处理。具体现象如下：

发现一部分时间正确，一部分时间错误；正确的和错误的没有顺序。解决思路如下：

### 1、排除后端传值错误

早上刚刚上班，我输入了几个数据和测试时间，前端界面显示正常。我想可能不是前端的bug，应该是后端bug。

首先我看了一下后端的传值（先看看是否是后端的问题，毕竟这个是数据错误），带着一脸问号找后端，和后端同事协调后，结果发现后端的数据写入正确，请求返回的数据正确（结果啪啪打脸）。

### 2、时区的问题

排除了原始数据的问题，我仔细对比数据差异。发现错误的数据中，分钟和秒是正确的，但是小时不正确。是不是不同的客户处于不同的时区（中国在东八区，美国和中国相差12小时）。我联系了不同的北京同事，他们的数据有的正确，有的不正确。

我们的时间使用第三方库 moment.js 处理。查阅了详细的官方文档（http://momentjs.cn/），没有发现配置的问题，这里可以排除。这里浪费了不少时间。

### 3、最终原因：时间格式

完全找不到问题，代码逻辑看起来基本一样，于是我把两个源代码一行一行对比分析，发现了下面的问题。

~~~js
// 一个界面
let time = moment(value).format('YYYY-MM-DD hh:mm:ss');
// 另一个界面
let time = moment(value).format('YYYY-MM-DD HH:mm:ss');
~~~

第一眼看起来没问题（在上千行的代码中基本没差别），首先用 moment 处理一下传值，然后格式化一下输出，输出都是按照年月日时分秒输出。

仔细对比找到了问题，一个是 “HH” 一个是 "hh"。查阅官方文档，是12小时格式和24小时格式原因（下午八点和20点的区别），这样问题基本找出来了。

我测试时是上午，12小时和24小时制度下时间是正确的；如果是下午和晚上的数据，那么时间转换就错误了。我们的界面上没有标明上午或者下午，所以两个时间就出错了。问题解决！把两个地方的时间格式改成相同，然后界面就是正确的了。

查看源码，发现这两个界面是不同的同事写的，可能没有及时沟通，或者是手误，造成格式化错误。

修复了这个问题后，下午测试，时间正确。这个问题终于解决了。

### 总结

moment 这个库很复杂。如果遇到国际的业务，需要不用时区时间格式，一定仔细阅读文档，做好测试，避免上面的错误，否则数据错误就是很严重的问题。